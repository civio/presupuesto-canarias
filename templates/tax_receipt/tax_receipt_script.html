<script>
  $(function () {
    var totalTaxPaid = 0;

    // Display amount as expense per capita
    function calculatePersonalTax(value, type, item) {
      if (value == null) return null;
      if (type === 'filter') return value;  // We filter based on the raw data

      var percentage = value / getBreakdownValue(item.root);
      return formatDecimal(percentage * totalTaxPaid) + " €";
    }

    function formatTaxAmount(value, decimals) {
      var format = (decimals == false) ? '0,0' : '0,0.00';
      return numeral(value).format( format, Math.floor ) + " €";
    }

    function calculateTaxAmount(val){

      // get input placeholder if empty value
      val = (val !== '') ? val : $('#input-incomes').attr('placeholder')

      if (val < 3000) {
        val = 3000;
        $('#input-incomes').val(val);
      }

      // set income amount
      $('#income-amount').html( formatTaxAmount(val, false) );

      // Finalmente, sumamos las cuotas de IRPF, IIEE e IVA para obtener lo que el ciudadano paga de impuestos:
      return val * 0.1620;
    }

    function redrawGrid(e) {
      if(e){
        e.preventDefault();
      }

      totalTaxPaid = calculateTaxAmount($('#input-incomes').val());
      
      $('#tax-amount-paid').html( formatTaxAmount(totalTaxPaid) );

      if ( myGrid !== undefined )  myGrid.destroy();
      myGrid = createBudgetGrid("#myGrid", gridData, [
        { data: "label", title: '{{ _("Política") }}', render: getPolicyLinkFormatter() },
        {
          data: getBreakdownValue,
          title: '{{ _("Gasto") }}',
          render: calculatePersonalTax,
          year: breakdown.years['{{ latest_budget.name()|safe }}']
        }
      ]);
    }

    var breakdown = {{ breakdown.to_json( labels=descriptions['functional'] )|safe }};
    var gridData = breakdownToTable(breakdown);
    var getBreakdownValue = getBreakdownValueFunction('expense', '{{ latest_budget.name()|safe }}');
    var myGrid;

    $("#tax-receipt-form").submit(redrawGrid);
    $("#input-incomes").change(redrawGrid);
    redrawGrid();
  })
</script>